# Untitled
Sheng Luan  
2017年7月11日  


* data.table的特点：**减小计算复杂度**，降低**计算时间**。  

# 1.主键

利用主键进行subset，速度会更加快。
## 1.1 设置主键
通过函数`setkey()`来设置主键。下边代码将origin列设置为主键。

```r
setkey(flights,origin)
setkey(flights,"origin")
head(flights)
```

```
##    year month day dep_time dep_delay arr_time arr_delay cancelled carrier
## 1: 2014     1   1     1824         4     2145         0         0      AA
## 2: 2014     1   1     1655        -5     2003       -17         0      AA
## 3: 2014     1   1     1611       191     1910       185         0      AA
## 4: 2014     1   1     1449        -1     1753        -2         0      AA
## 5: 2014     1   1      607        -3      905       -10         0      AA
## 6: 2014     1   1      949         4     1243       -17         0      AA
##    tailnum flight origin dest air_time distance hour min
## 1:  N3DEAA    119    EWR  LAX      339     2454   18  24
## 2:  N5CFAA    172    EWR  MIA      161     1085   16  55
## 3:  N471AA    300    EWR  DFW      214     1372   16  11
## 4:  N4WNAA    320    EWR  DFW      214     1372   14  49
## 5:  N5DMAA   1205    EWR  MIA      154     1085    6   7
## 6:  N491AA   1223    EWR  DFW      215     1372    9  49
```
origin列设置为主键后，一个明显特征，其中的元素从小到大排序了。
列被setkey后，速度提升很快。利用microbenchmark包进行测试。设置为主键后，的确快一些。

```r
require(microbenchmark)
```

```
## Loading required package: microbenchmark
```

```r
microbenchmark(flights[.("JFK")],flights.copy[origin == "JFK"])
```

```
## Unit: milliseconds
##                           expr      min       lq     mean   median
##              flights[.("JFK")] 5.790643 6.959618 20.99991 7.534416
##  flights.copy[origin == "JFK"] 7.116013 8.594922 12.14634 9.350903
##         uq        max neval cld
##   9.020537 1208.91805   100   a
##  12.218280   57.92295   100   a
```

* 因为已经将主键设置为 origin列了，所以只要直接指定"JFK"就可以了。这里 .()用来在data.table的主键（也就是flights 的 origin列）里，查找"JFK"。
* 首先，满足"JFK"条件的行的索引都被获取到。然后，这些行的哪些信息是必要的呢。既然参数j里没有指定任何表达式，这些行的所有列都被返回了。
* 如果主键是字符型的列，那么可以省略 .()，就像用行名subset一个data.frame的行的时候。
flights["JFK"]              ## same as flights[.("JFK")]

* 我们可以根据需要指定多个值
flights[c("JFK", "LGA")]    ## same as flights[.(c("JFK", "LGA"))]
这返回所有 origin列是“JFK” 或者 “LGA”的所有行。

```r
flights[c("JFK", "LGA")]
```

```
##         year month day dep_time dep_delay arr_time arr_delay cancelled
##      1: 2014     1   1      914        14     1238        13         0
##      2: 2014     1   1     1157        -3     1523        13         0
##      3: 2014     1   1     1902         2     2224         9         0
##      4: 2014     1   1     1347         2     1706         1         0
##      5: 2014     1   1     2133        -2       37       -18         0
##     ---                                                               
## 165912: 2014    10  31      609        24      843        -5         0
## 165913: 2014    10  31     1459         1     1747       -30         0
## 165914: 2014    10  31     1102        -8     1311        16         0
## 165915: 2014    10  31     1106        -4     1325        15         0
## 165916: 2014    10  31      824        -5     1045         1         0
##         carrier tailnum flight origin dest air_time distance hour min
##      1:      AA  N338AA      1    JFK  LAX      359     2475    9  14
##      2:      AA  N335AA      3    JFK  LAX      363     2475   11  57
##      3:      AA  N327AA     21    JFK  LAX      351     2475   19   2
##      4:      AA  N319AA    117    JFK  LAX      350     2475   13  47
##      5:      AA  N323AA    185    JFK  LAX      338     2475   21  33
##     ---                                                              
## 165912:      UA  N16709   1714    LGA  IAH      198     1416    6   9
## 165913:      UA  N23708   1744    LGA  IAH      201     1416   14  59
## 165914:      MQ  N827MQ   3591    LGA  RDU       83      431   11   2
## 165915:      MQ  N511MQ   3592    LGA  DTW       75      502   11   6
## 165916:      MQ  N813MQ   3599    LGA  SDF      110      659    8  24
```

```r
flights[.(c("JFK", "LGA"))]
```

```
##         year month day dep_time dep_delay arr_time arr_delay cancelled
##      1: 2014     1   1      914        14     1238        13         0
##      2: 2014     1   1     1157        -3     1523        13         0
##      3: 2014     1   1     1902         2     2224         9         0
##      4: 2014     1   1     1347         2     1706         1         0
##      5: 2014     1   1     2133        -2       37       -18         0
##     ---                                                               
## 165912: 2014    10  31      609        24      843        -5         0
## 165913: 2014    10  31     1459         1     1747       -30         0
## 165914: 2014    10  31     1102        -8     1311        16         0
## 165915: 2014    10  31     1106        -4     1325        15         0
## 165916: 2014    10  31      824        -5     1045         1         0
##         carrier tailnum flight origin dest air_time distance hour min
##      1:      AA  N338AA      1    JFK  LAX      359     2475    9  14
##      2:      AA  N335AA      3    JFK  LAX      363     2475   11  57
##      3:      AA  N327AA     21    JFK  LAX      351     2475   19   2
##      4:      AA  N319AA    117    JFK  LAX      350     2475   13  47
##      5:      AA  N323AA    185    JFK  LAX      338     2475   21  33
##     ---                                                              
## 165912:      UA  N16709   1714    LGA  IAH      198     1416    6   9
## 165913:      UA  N23708   1744    LGA  IAH      201     1416   14  59
## 165914:      MQ  N827MQ   3591    LGA  RDU       83      431   11   2
## 165915:      MQ  N511MQ   3592    LGA  DTW       75      502   11   6
## 165916:      MQ  N813MQ   3599    LGA  SDF      110      659    8  24
```
使用函数 `key()`,获得被设置为主键的列名 

```r
key(flights)
```

```
## [1] "origin"
```

```r
key(flights.copy)
```

```
## NULL
```

* 函数 key() 返回主键列名的字符型向量。
* 如果data.table没有设置过主键，返回 NULL。
