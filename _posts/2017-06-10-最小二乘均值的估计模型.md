---
layout: post
title: 最小二乘均值的估计模型
categories: 统计学 线性混合效应模型  
description: 如何检验固定效应和随机效应的显著性.
keywords: random effect, fixed effect, significant, lsmeans
---
# 1.最小二乘均值的定义和背景
## 1.1 最小二乘均值的定义（来自lsmeans包简介）

least-squares means (LS means for short) for a linear model are simply predictions-or averages thereof-over a regular grid of predictor settings which I call **the reference grid**, 简称为LS means。Ls means的历史可以追溯到1960年，1977年Harvey写出了计算机程序LSML，并且贡献了SAS软件中的HARVEY过程。以后，lsmeans声明加入到了SAS的各种过程如GLM中。

在协方差分析模型中 LS means与协变量校正均值（covariate-adjusted means）相同。在不平衡因子试验中，每一个因子的LS means跟主效应均值非常相似，但是进行了不平衡校正。后边这种解释，跟未加权的均值（unweighted means)方法非常相似。

LS means 并不是很好理解，术语本身就会令人迷惑。[Searle（1980）](1)年详细的讨论了对于各种因子、嵌套和协方差模型，该如何定义最小二乘均值。Searle建议利用术语"predicted marginal means"来代替"least-squares means",可能更为合理。

需要强调的两点：

* 最小二乘均值根据参考表格（reference grid）计算
* 一旦建立了参考表格，最小二乘均值就是基于表格的简单预测，或者说是预测值列表的边际均值（marginal means）。

## 1.2 参考表格（reference grid）
* 如果预测对象是因子，那么因子中的每个水平作为参考水平。
### 1.2.1 橙子售卖数据集
oranges的数据集结构如下：

* 两个品种，对应两个价格（price1和price2）和两个销量（sales1和sales2）；
* 然后还有store和day两个列变量，分别表示售卖的商店和时间；
* store和dya两个变量为因子类型，价格为整数类型，销量为数字类型。

```r
dim(oranges)
```

```
## [1] 36  6
```

```r
head(oranges)
```

```
##   store day price1 price2  sales1  sales2
## 1     1   1     37     61 11.3208  0.0047
## 2     1   2     37     37 12.9151  0.0037
## 3     1   3     45     53 18.8947  7.5429
## 4     1   4     41     41 14.6739  7.0652
## 5     1   5     57     41  8.6493 21.2085
## 6     1   6     49     33  9.5238 16.6667
```

```r
str(oranges)
```

```
## 'data.frame':	36 obs. of  6 variables:
##  $ store : Factor w/ 6 levels "1","2","3","4",..: 1 1 1 1 1 1 2 2 2 2 ...
##  $ day   : Factor w/ 6 levels "1","2","3","4",..: 1 2 3 4 5 6 1 2 3 4 ...
##  $ price1: int  37 37 45 41 57 49 49 53 53 53 ...
##  $ price2: int  61 37 53 41 41 33 49 53 45 53 ...
##  $ sales1: num  11.32 12.92 18.89 14.67 8.65 ...
##  $ sales2: num  0.0047 0.0037 7.5429 7.0652 21.2085 ...
```



SAS、单机版ASReml、R中的包lsmeans和ASReml-R都可以计算该值。
在动物育种中 ，lsmeans经常用作不同群体性能的比较。
假定有3个群体，每个群体包含数量不等的家系，本文的目的是比较不同群体的生长性能，即收获体重的差异。

# 2. 固定效应和随机效应的显著性检验
## 2.1 固定效应
如果模型中同时包括固定效应和随机效应，首先建立只包括固定效应（除残差随机效应外）的模型，通过**Wald F**统计检验显著性。

在ASReml中，**Wald F**统计检验方法的方法有两种，F-inc和F-con。F-inc表示incremental form，F-con表示conditional form。

模型：

$$y_{ijkln}=\mu+Pop_{i}+Sex_{j}+Tank_{k}+Sex_{i}×Tank_{k}+Tbw_{l}(Sex_{i}×Tank_{k})+e_{ijkln}$$

ASReml代码：

``` ASReml
!PATH 1 #估计固定效应的显著性
!cycle 3 6 7 8
Input2014/growthG$I.csv !SKIP 1 !MAXIT 150 !EXTRA 5 !MVINCLUDE !SUM
TABULATE HarvestBW StockingMeanBW !stats ~ FamilyClass
!DDF
HarvestBW ~ mu  FamilyClass Sex TankID Sex.TankID Sex.TankID.StockingMeanBW
```
ASreml输出的结果文件.asr中的LogL值的结果（8的结果）：
``` ASReml
 Univariate analysis of HarvestBW                                       
 Summary of 11989 records retained of 11989 read
  Warning: Fewer levels found in AnimalID  than specified
  Warning: Fewer levels found in SireID  than specified
  Warning: Fewer levels found in DamID  than specified
  Warning: Fewer levels found in Generation  than specified
 Forming       16 equations:  16 dense.
 Initial updates will be shrunk by factor    0.316
 Notice: LogL values are reported relative to a base of -30000.000    
 Notice: 6 singularities detected in design matrix.
   1 LogL=-4887.55     S2=  123.83      11979 df 
   2 LogL=-4887.55     S2=  123.83      11979 df 
   3 LogL=-4887.55     S2=  123.83      11979 df 
   4 LogL=-4887.55     S2=  123.83      11979 df 
   5 LogL=-4887.55     S2=  123.83      11979 df 
   6 LogL=-4887.55     S2=  123.83      11979 df 
```

ASreml输出的结果文件.asr中的Wald F检验结果：所有固定效应及其交互效应都是显著的。因此需要将他们都包括在分析模型中。

``` ASReml
                                   Wald F statistics
     Source of Variation           NumDF     DenDF    F-inc            P-inc
  14 mu                                1   11979.0 0.18E+06            <.001
   7 FamilyClass                       2   11979.0    47.90            <.001

   5 Sex                               1   11979.0  8420.41            <.001
   6 TankID                            1   11979.0   803.90            <.001
  15 Sex.TankID                        1   11979.0    32.54            <.001
  17 Sex.TankID.StockingMeanBW         4   11979.0   321.53            <.001
```

## 2.2 随机效应
每个群体中包括数量不等的家系，为了去除群体内家系结构的差异，需要把家系作为随机效应去除掉。
模型：

$$y_{ijkln}=\mu+Pop_{i}+Sex_{j}+Tank_{k}+Sex_{i}×Tank_{k}+Tbw_{l}(Sex_{i}×Tank_{k})+\\ +Fam_{l}(Pop_{i})+e_{ijkln}$$

ASReml代码

```ASReml
!PATH 2 # PATH 1中模型的结果表明，所有的固定效应和协变量都是显著的，进一步加入家系效应,作为随机效应
!cycle 3 6 7 8
Input2014/growthG$I.csv !SKIP 1 !MAXIT 150 !EXTRA 5 !MVINCLUDE !SUM
TABULATE HarvestBW StockingMeanBW !stats ~ FamilyClass
!DDF
HarvestBW ~ mu  FamilyClass Sex TankID Sex.TankID Sex.TankID.StockingMeanBW !r FamilyClass.FamilyID
```



LogL值：`LogL=-4573.14`，大于2.1部分`LogL=-4887.55`，因此需要将全同胞家系组效应作为随机效应保留在分析模型中。

``` ASReml
 Univariate analysis of HarvestBW                                       
 Summary of 11989 records retained of 11989 read
  Warning: Fewer levels found in AnimalID  than specified
  Warning: Fewer levels found in SireID  than specified
  Warning: Fewer levels found in DamID  than specified
  Warning: Fewer levels found in Generation  than specified
 QUALIFIERS: predict FamilyClass !TDIFF 
 Forming      388 equations:  16 dense.
 Initial updates will be shrunk by factor    0.316
 Notice: LogL values are reported relative to a base of -30000.000    
 Notice: 6 singularities detected in design matrix.
   1 LogL=-4573.86     S2=  114.78      11979 df   0.1000    
   2 LogL=-4573.45     S2=  114.84      11979 df   0.9397E-01
   3 LogL=-4573.19     S2=  114.90      11979 df   0.8755E-01
   4 LogL=-4573.14     S2=  114.95      11979 df   0.8345E-01
   5 LogL=-4573.14     S2=  114.95      11979 df   0.8358E-01
   6 LogL=-4573.14     S2=  114.95      11979 df   0.8358E-01
   7 LogL=-4573.14     S2=  114.95      11979 df   0.8358E-01
   8 LogL=-4573.14     S2=  114.95      11979 df   0.8358E-01
   9 LogL=-4573.14     S2=  114.95      11979 df   0.8358E-01
  10 LogL=-4573.14     S2=  114.95      11979 df   0.8358E-01
 Final parameter values                        0.8358E-01
```

Wald F检验

``` ASReml
                                   Wald F statistics
     Source of Variation           NumDF     DenDF    F-inc            P-inc
  14 mu                                1     119.0 20904.91            <.001
   7 FamilyClass                       2     118.2     5.15            0.007

   5 Sex                               1   11922.3  8887.92            <.001
   6 TankID                            1   11912.6   795.62            <.001
  15 Sex.TankID                        1   11891.1    37.25            <.001
  17 Sex.TankID.StockingMeanBW         4     898.5   145.53            <.001
```

## 2.3 模型中进一步考虑平滑样本曲线
在模型分析中，通过初始体重变量对收获体重进行校正。由于不同群体的初始体重，可能会存在一个较大的差别，不同初始体重，生长速度存在不同，因此用三次平滑样本曲线，可以更加精确地对结果进行校正。
ASReml代码：通过spl()函数来实现上述功能。

``` ASReml
!PATH 3 #在PATH 2的基础上，进一步加入spl(StockingMeanBW)随机效应
!cycle 3 6 7 8
Input2014/growthG$I.csv !SKIP 1 !MAXIT 150 !EXTRA 5 !MVINCLUDE !SUM
TABULATE HarvestBW StockingMeanBW !stats ~ FamilyClass
!DDF
HarvestBW ~ mu  FamilyClass Sex TankID Sex.TankID Sex.TankID.StockingMeanBW !r FamilyClass.FamilyID Sex.TankID.spl(StockingMeanBW)
```
LogL值：与2.2 `LogL=-4573.14`相比，本次`LogL=-4526.67`，更大，且似然比检验明显会达到显著水平。因此在模型中应该加入spl函数对收获体重进行校正。

``` ASReml
   1 LogL=-4592.74     S2=  112.75      11979 df    :   1 components restrained
   2 LogL=-4549.23     S2=  113.53      11979 df    :   1 components restrained
   3 LogL=-4527.87     S2=  114.01      11979 df   0.4000E-03 0.5931E-01
   4 LogL=-4526.87     S2=  114.20      11979 df   0.1467E-03 0.5565E-01
   5 LogL=-4526.68     S2=  114.17      11979 df   0.1847E-03 0.5548E-01
   6 LogL=-4526.67     S2=  114.16      11979 df   0.1960E-03 0.5523E-01
   7 LogL=-4526.67     S2=  114.16      11979 df   0.1972E-03 0.5517E-01
   8 LogL=-4526.67     S2=  114.16      11979 df   0.1973E-03 0.5516E-01
   9 LogL=-4526.67     S2=  114.16      11979 df   0.1973E-03 0.5516E-01
  10 LogL=-4526.67     S2=  114.16      11979 df   0.1973E-03 0.5516E-01
  11 LogL=-4526.67     S2=  114.16      11979 df   0.1973E-03 0.5516E-01
 Final parameter values                        0.1973E-03 0.5516E-01
```
Wald F 检验，所有固定效应和协变量均达到极显著水平。

在分析过程中，存在一种情况，模型中只包括固定效应时，各种效应的Wald F检验达到显著或极显著水平。  
但是加入**随机效应**后，原先的固定效应可能会**不再显著**。  
在这种情况下，**以没有包括随机效应的模型拟合结果为准，固定效应保留。**

``` ASReml
                                   Wald F statistics
     Source of Variation           NumDF     DenDF    F-inc            P-inc
  14 mu                                1     126.6 19176.67            <.001
   7 FamilyClass                       2     115.0     8.89            <.001

   5 Sex                               1    2074.6  4361.97            <.001
   6 TankID                            1    2162.5   488.94            <.001
  15 Sex.TankID                        1    2162.0    15.08            <.001
  17 Sex.TankID.StockingMeanBW         4     170.1    17.27            <.001
```

## 2.4 最小二乘均值
``` ASReml
predict FamilyClass !TDIFF
```
上述语句放在模型语句后边，ASReml生成一个.pvs文件，包括三个群体的最小二乘均值:
``` ASReml
 Predicted values of HarvestBW                                       
 Model terms involving  StockingMeanBW  are predicted at the average:       1.3630
 The SIMPLE averaging set:  TankID Sex 
 The ignored set: FamilyID 

 FamilyClass     Predicted_Value Standard_Error Ecode
 SPWP                    46.0236         0.7740 E
 SP                      46.8604         0.3769 E
 WP                      43.7606         0.8069 E
 SED: Standard Error of Difference: Min      0.7881    Mean      0.8848    Max      1.0546 

 Predicted values with t statistics
   46.02    
   46.86       1.06
   43.76      -2.15  -3.82
```
`!TDIFF`限定符，给出了最小二乘均值的T统计检验值。在ASReml-R中，提供了`predict()`函数解析`asreml()`计算出的模型结果，计算最小二乘均值。  
对于lsmeans包，提供了`lsmeans()`函数，可以对lme4、nlme等线性混合效应模型包的输出结果进行解析，求解最小二乘均值。

<1> Searle SR, Speed FM, Milliken GA (1980). \Population marginal means in the linear model: An
alternative to least squares means." The American Statistician, 34(4), 216{221.